YUI.add("itsa-mojitonthefly",function(e){"use strict";var t="application/json",n="pure-menu-selected",r=e.Array,i=e.Object,s="pjax",o=e.one("body"),u=e.one("head"),a=3600,f=function(e,t){e.setTime(e.getTime()+1e3*t)},l,c=e.UA,h=e.config.win,p=e.config.doc,d={},v,m=!!(h.history&&h.history.pushState&&h.history.replaceState&&("onpopstate"in h||c.gecko>=2)&&(!c.android||c.android>=2.4)),g=new RegExp("^([a-z][a-z0-9+\\-.]*:(\\/\\/[^/?#]+)?)?(\\/?[a-z0-9\\-._~%!$&'()*+,;=@]+(\\/[a-z0-9\\-._~%!$&'()*+,;=:@]+)*\\/?|\\/)([#?]|$)","i");v=e.Promise.EventNotifier=function(){this._targets=[]},v.decorate=function(e){return e._evts?e:(e._evts={subs:{},targets:[]},e.on=function(t,n){return t&&n&&(e._evts.subs[t]||(e._evts.subs[t]=[]),e._evts.subs[t].push(n)),e},e.then=function(e){return function(t,n){var r=v.decorate(e.call(this,t,n));return this._evts.targets.push(r),r}}(e.then),e)},e.mix(v.prototype,{addEvents:function(e){var t=this._targets;return t.push(e),e["catch"](function(){return!0}).then(function(){t.splice(t.indexOf(e),1)}),v.decorate(e)},fire:function(t){var n=this._targets.slice(),i={},s=arguments.length>1&&r(arguments,1,!0),o,u,a,f,l,c,h;s&&s.unshift(null,null);for(a=0;a<n.length;++a){o=n[a];if(n[a]._evts){c=e.stamp(n[a]);if(i[c])continue;i[c]=1,n.push.apply(n,n[a]._evts.targets),u=o._evts.subs[t];if(u)for(f=0,l=u.length;f<l;++f)h=u[f],s&&(s[0]=h,h=e.bind.apply(e,s)),e.soon(h)}}return this}}),e.io.xhr=function(t,n){return n=n||{},new e.Promise(function(r,i){var s=e.io(t,{method:n.method,data:n.data,headers:n.headers,form:n.form,timeout:n.timeout,on:{success:function(e,t){r(t)},failure:function(e,t){i(t)}}});this.abort=s.abort})},e.io.json=function(n,r){r=r||{},r.headers||(r.headers={}),r.headers.Accept=t;var i=e.io.xhr(n,r);return e.mix(i.then(function(t){return e.JSON.parse(t.responseText,r.reviver)}),{abort:i.abort})},e.io.getJSON=function(t,n){return n=n||{},n.method="GET",e.io.json(t,n)},l=function(t,n,s,a,l){var c=t.assets,p=c&&c.top,d=c&&c.bottom,v=p&&p.css||[],m=d&&d.css||[],g=p&&p.js||[],y=d&&d.js||[],b=p&&p.blob||[],w=d&&d.blob||[],E=h.YMojito.client,S,x,T,N,C,k,L,A,O;return k=e.Node.create(t.view),L=function(e){i.each(E._mojits,function(t,n){e.one("#"+n)&&(t.proxy._binder&&t.proxy._binder.destructor&&t.proxy._binder.destructor(),E.destroyMojitProxy(n,!1))})},C=function(){L(n),n.empty(),n.setHTML(k),r.each(w,function(e){o.append(e+"\n")}),t.binders&&E.attachBinders(t.binders),x&&x.length>0&&e.Get.load(x,{insertBefore:T})},a?C():(m.length+y.length+w.length>0&&(N=o.get("children"),T=N.item(N.size()-1)),S=l?g:v.concat(g),x=l?y:m.concat(y),r.each(b,function(e){u.append(e+"\n")}),S.length>0?e.Get.load(S,C):C()),A={viewId:k.get("id"),containerNode:n,title:t.title},s&&(O=new Date,f(O,s),A.view=t.view,A.binders=t.binders,A.expire=O),e.Promise.resolve(A)},e.Node.prototype.loadMojit=function(t,n){var r=this,i=d[t],s={"M-FLY-MOJIT":t},o,u,a,f;return n&&(s["M-FLY-ACTION"]=n),i||(s["M-FLY-FULL"]=!0),u=h.location.href.match(g),o=u[1],r._loadMojitTransaction&&r._loadMojitTransaction.abort(),f=e.io.getJSON(o,{headers:s}),r._loadMojitTransaction=a=e.mix(f.then(function(e){return d[t]=!0,l(e,r,null,i,!1)}),{abort:f.abort}),a},e.namespace("mojito").pjax=function(){var t={},r,u,c,d,v,y,b,w,E,S,x,T,N;return u=function(){var t,n;m&&(T=h.location.href.match(g),t=T[3],n=e.one('a[data-pjax-initialstate="true"]'),e.publish(s,{defaultFn:x,emitFacade:!0}),r=new e.HistoryHTML5,n&&y(t,p.title,n,!0),N=new e.Promise.EventNotifier,c(),e.later(60,null,E,t))},b=function(e,t){e.all("li").removeClass(n),t.addClass(n)},y=function(t,n,i,s){i.get("id")||i.set("id",e.guid()),s?r.replace({uri:t,targetid:i.get("id")},{url:t,title:n}):r.get("uri")===t||r.add({uri:t,targetid:i.get("id"),xpos:h.pageXOffset||p.documentElement.scrollLeft,ypos:h.pageYOffset||p.documentElement.scrollTop},{url:t,title:n})},E=function(e){o.all('a[data-pjax-preload], a[data-pjax-initialstate="true"]').each(function(t){var n=t.getAttribute("href");w(t,n,S(t,!0),n===e,!0,!0,!1)})},S=function(e,t){var n=e.getAttribute("data-pjax-preload"),r;return t?r=n==="true"?a:n:(r=e.getAttribute("data-pjax-cache")||v||n,r==="true"&&(r=a)),r},c=function(){e.on("history:change",function(t){var n=t.newVal,r=t.src==="popstate",i=n.uri,o=n.targetid,u=r&&o&&e.one("#"+o);u&&i&&e.fire(s,{uri:i,targetnode:u,fromhistorychange:!0,xpos:n.xpos,ypos:n.ypos})}),o.delegate(["tap","click"],function(t){var n=t.currentTarget;t.type==="click"?t.preventDefault():e.fire(s,{uri:n.getAttribute("href"),targetnode:n,fromhistorychange:!1})},"a[data-pjax-mojit]")},x=function(n){var r=n.uri,i=n.targetnode,s=n.fromhistorychange,o,u,a,c,p,d;s&&(i.focus(),h.scrollTo(n.xpos,n.ypos)),d=i.get("parentNode"),p=d.get("parentNode").get("parentNode"),p.hasClass("pure-menu")&&b(p,d),a=t[r],u=S(i),a?a.then(function(n){n.expire&&n.expire.getTime()>Date.now()?(N.fire("cancel",{container:n.containerNode}),c=n.expire.getTime(),t[r]=n.preload?l(n.response,n.containerNode,u,!1,!0):l({view:n.view,binders:n.binders,title:n.title},n.containerNode,u,!0,!1),t[r].expire&&t[r].expire.setTime(c),s||y(r,n.title,i)):e.one("#"+n.viewId)?(N.fire("cancel",{container:n.containerNode}),o=h.YMojito.client._mojits[n.viewId],o&&o.proxy.refreshView(),n.expire&&(n.expire=new Date,f(n.expire,u)),s||y(r,n.title,i)):w(i,r,u,n.preload?!1:!0,!1,s,n.preload)},function(){w(i,r,u,!1,!1,s)}):w(i,r,u,!1,!1,s)},w=function(n,r,i,s,u,a,c){var h=n.getAttribute("data-pjax-container"),v=h&&e.one(h)||d||o,m,g,b,w;m=n.getAttribute("data-pjax-mojit"),g=n.getAttribute("data-pjax-action"),b={"M-PJAX":!0},m&&(b["M-PJAX-MOJIT"]=m),g&&(b["M-PJAX-ACTION"]=g),s||(b["M-PJAX-FULL"]=!0),u||N.fire("cancel",{container:v}),w=e.io.getJSON(r,{headers:b}),a||y(r,p.title,n),w.then(function(h){var p,d,m,g,b,w,E;a||y(r,h.title,n,!0),u?(m=h.assets,g=m&&m.top&&m.top.css||[],b=m&&m.bottom&&m.bottom.css||[],g.length>0&&e.Get.load(g),b.length>0&&(w=o.get("children"),E=w.item(w.size()-1),e.Get.load(b,{insertBefore:E})),d={response:h,
containerNode:v,preload:!0},i&&(p=new Date,f(p,i),d.expire=p),t[r]=e.Promise.resolve(d)):t[r]=l(h,v,i,s,c)}),w.preload=u,w.container=v,N.addEvents(w),w.on("cancel",function(e){var t=w;t.preload||t.container!==e.container||t.abort()})},u(),{setContainer:function(e){d=e},setCacheTime:function(e){typeof e=="number"&&(v=e)},emptyCache:function(){var e=Date.now()-1;i.each(t,function(t){var n=t;n.then(function(t){t.expire=e})})},pjaxAvailable:function(){return m},simulateAnchorClick:function(t){var n=t.get("tagName")==="A"&&t.getAttribute("data-pjax-mojit");n&&e.fire(s,{uri:t.getAttribute("href"),targetnode:t,fromhistorychange:!1})}}}()},"0.0.1",{requires:["node-base","promise","node-event-delegate","history-html5","event-tap","get","io-base","json-parse"]});
